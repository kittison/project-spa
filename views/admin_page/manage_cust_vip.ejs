<style>
    .container-fluid {
        padding: 12px;
    }

    .modal-body {
        padding-left: 30px;
        padding-right: 30px;
    }

    .modal-footer {
        padding-left: 30px;
        padding-right: 30px;
    }

    .form-control {
        background-color: rgba(175, 175, 175, 0.3);
    }
</style>

<div class="container-fluid">
    
    <div class="d-flex justify-content-center">
        <div class="">
            <div class="card card-body text-center" style="padding-left: 40px; padding-right: 40px;">
                <h3>ระบบจัดการข้อมูลบัตร vip ของลูกค้า : <%= db_cust[0].f_name %> <%= db_cust[0].l_name %></h3>
            </div>
        </div>
    </div>

    <div class="d-flex  justify-content-start mb-2" style="gap: 5px;">
        <a href="manage_cust" class="btn btn-info">กลับไปที่จัดการข้อมูลลูกค้า</a>
        <button  type="button" class="btn btn-success" data-toggle="modal" data-target="#modal-add" onclick="">
            เพิ่มบัตร
        </button>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card card-body">
                
                <table id="vip-card" class="table table-bordered table-hover " >
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>คอร์ส</th>
                            <th>วันที่เข้าเป็น</th>
                            <th>วันที่หมดอายุ</th>
                            <th>ราคาที่ใช้ไป</th>
                            <th>ราคาคงเหลือ</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <% for(let i of db_cust_vip) {%>
                            <tr>
                                <td><%= i.id%></td>
                                <td><%= i.course_name%></td>
                                <% if(i.join_date){ %>
                                    <% let f_join_date = new Intl.DateTimeFormat('id-ID',{ day:'2-digit', month:'2-digit', year:'numeric', hour: 'numeric', minute: 'numeric', second: 'numeric', timeZoneName: 'short'}).format(i.join_date) %>
                                    <td><%= f_join_date%></td>
                                <% } else{ %>  
                                    <td>-</td>
                                <% } %>
                                <% if(i.expire_date){ %>
                                    <% let f_expire_date = new Intl.DateTimeFormat('id-ID',{ day:'2-digit', month:'2-digit', year:'numeric', hour: 'numeric', minute: 'numeric', second: 'numeric', timeZoneName: 'short'}).format(i.expire_date) %>
                                    <td><%= f_expire_date%></td>
                                <% } else{ %>  
                                    <td>-</td>
                                <% } %>
                                <td><%= i.acc_val%></td>
                                <td><%= i.remain_val%></td>
                                <td>
                                    <div class="">
                                        <button  type="button" class="btn btn-warning p-1 px-1" data-toggle="modal" data-target="#modal-update"onclick="update('<%=JSON.stringify(i)%>') ">แก้
                                        </button>
                                        <button  type="button" class="btn btn-danger p-1 px-1" onclick="del('<%=i.id%>')" >ลบ</button>
                                    </div>
                                </td>
                                
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>


<form id="delete" action="manage_cust_vip/delete" method="post" class="d-inline">
    <input type="number" name="cust_id" class="d-none" value="<%=db_cust[0].id%>">
    <input type="number" name="id_del" class="d-none" value="">
</form>

<!-- =================== Modal Insert ===================-->
<div class="modal fade" id="modal-add">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-purple">
          <h4 class="modal-title ">เพิ่มบัตร</h4>
          <button type="button " class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true" class="text-light">&times;</span>
          </button>
        </div>
        <form id="mange_add" action="manage_cust_vip/add" method="post">
            <div class="modal-body">
            <!-- ============================== Form ==============================-->
                <input type="number" name="cust_id" class="d-none" value="<%=db_cust[0].id%>">
                <div class="form-group">
                    <label>คอร์ส</label>
                    <select class="form-control" name="course_id" value="">
                        <% if (db_course.length > 0){%>
                            <option value="" disabled selected>เลือกคอร์ส</option>
                            <% for(i of db_course){%> 
                                <option  id="course_<%=i.id%>" value="<%=i.id%>"><%=i.name%> - <%=i.price%> บาท</option>
                            <%} %> 
                        <% } else{%>
                            <option value="" disabled selected>ไม่พบข้อมูล</option>
                        <%} %> 
                    </select>
                </div>
                <div class="form-group">
                    <label >วันที่เข้าเป็น</label>
                    <input type="datetime-local" class="form-control" name="join_date" step="60">
                </div>
                <div class="form-group">
                    <label >วันที่หมดอายุ</label>
                    <input type="datetime-local" class="form-control" name="expire_date" step="60">
                </div>
                <div class="form-group">
                    <label >ราคาที่ใช้ไป</label>
                    <input type="number" class="form-control" name="acc_val" min="0">
                </div>
                <div class="form-group">
                    <label >ราคาคงเหลือ</label>
                    <input type="number" class="form-control" name="remain_val" min="0">
                </div>

            </div>
            
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-default" data-dismiss="modal">ยกเลิก</button>
                <button type="submit" class="btn btn-primary" onclick="return vali('add')">ยืนยัน</button>
            </div>

        </form>

      </div>
    </div>
</div>


<!-- =================== Modal Update ===================-->
<div class="modal fade" id="modal-update">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-purple">
          <h4 class="modal-title ">แก้ไขข้อมูลบัตร</h4>
          <button type="button " class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true" class="text-light">&times;</span>
          </button>
        </div>

        <form id="mange_update" action="manage_cust_vip/update" method="post">
            <div class="modal-body">
            <!-- ============================== Form ==============================-->
                <input type="number" name="cust_id" class="d-none" value="<%=db_cust[0].id%>">
                <div class="form-group">
                    <label >คอร์ส</label>
                    <select class="form-control" name="Ucourse_id" value="">
                        <% if (db_course.length > 0){%>
                            <option value="" disabled selected>เลือกคอร์ส</option>
                            <% for(i of db_course){%> 
                                <option  id="Ucourse_<%=i.id%>" value="<%=i.id%>"><%=i.name%> - <%=i.price%> บาท</option>
                            <%} %> 
                        <% } else{%>
                            <option value="" disabled selected>ไม่พบข้อมูล</option>
                        <%} %> 
                    </select>
                </div>
                <div class="form-group">
                    <label >วันที่เข้าเป็น</label>
                    <input type="datetime-local" class="form-control" name="Ujoin_date" step="60">
                </div>
                <div class="form-group">
                    <label >วันที่หมดอายุ</label>
                    <input type="datetime-local" class="form-control" name="Uexpire_date" step="60">
                </div>
                <div class="form-group">
                    <label >ราคาที่ใช้ไป</label>
                    <input type="number" class="form-control" name="Uacc_val" min="0">
                </div>
                <div class="form-group">
                    <label >ราคาคงเหลือ</label>
                    <input type="number" class="form-control" name="Uremain_val" min="0">
                </div>
                <input type="number" name="id_update" class="d-none" value="">
            </div>

            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-default" data-dismiss="modal">ยกเลิก</button>
                <button type="submit" class="btn btn-primary" onclick="return vali('update')">ยืนยัน</button>
            </div>

        </form>

      </div>
    </div>
</div>


<script src="/axios/axios.min.js"></script>
<script>
    function axios_validation(url,params,form_id,error_text){
        axios({
            url:url,
            method:'get',
            params:params,
            timeout:3000
        }).then((result)=>{
            if( result.data.status == 1){
                $(form_id).submit();
            }else{
                toastr.error(error_text)
            }
        }).catch(()=>{
            toastr.error("404 Error Not Found")
        });
    }
</script>



<script>
    
    
    $(function () {
      $('#vip-card').DataTable({
        "paging": true,
        "lengthMenu": [[5, 10, 20], [5, 10, 20]],
        "searching": true,
        "ordering": true,
        "info": true,
        "autoWidth": false,
        "responsive": true,
      });
      
    });

    let oldOp ="";
    function update(data){
        data = JSON.parse(data)
        $("input[name=Ujoin_date]").val(formatDateTimeForInput(data.join_date));
        $("input[name=Uexpire_date]").val(formatDateTimeForInput(data.expire_date));
        $("input[name=Uacc_val]").val(data.acc_val);
        $("input[name=Uremain_val]").val(data.remain_val);         
        $("input[name=id_update]").val(data.id);

        let new_select = data.serv_course_id;
        $(`option[id=Ucourse_${new_select}]`).attr("selected","true");
        if(oldOp !== new_select ){
            if(oldOp != ""){
                $(`option[id=Ucourse_${oldOp}]`).removeAttr("selected");
            }
            oldOp = new_select ;
        }

    }

    function del(id){
        $("input[name=id_del]").val(parseInt(id))
        if(confirm("ยืนยันการลบข้อมูล") == true){
            $("#delete").submit();
        }
    }

    function vali(mode){
        /*
            Mode insert , update 
        */
        // (document.querySelector("input[name=Fname]").innerText).trim()
        if(mode === "add"){
            let course_id = $("select[name=course_id]").val();
            let join_date = $("input[name=join_date]").val();
            let expire_date = $("input[name=expire_date]").val();
            let acc_val = $("input[name=acc_val]").val();
            let remain_val = $("input[name=remain_val]").val();
            if( course_id && join_date !== "" && expire_date !== "" && acc_val !== "" && remain_val !== ""){
                $('#mange_add').submit();
            }else{
                toastr.error("! กรุณาใส่ข้อมูลให้ครบ")
            }
            return false;
        }else if(mode === "update"){
            let id_update = $("input[name=id_update]").val();
            let Ujoin_date = $("input[name=Ujoin_date]").val();
            let Uexpire_date = $("input[name=Uexpire_date]").val();
            let Uacc_val = $("input[name=Uacc_val]").val();
            let Uremain_val = $("input[name=Uremain_val]").val();
            if( id_update && Ujoin_date !== "" && Uexpire_date !== "" && Uacc_val !== "" && Uremain_val !== ""){
                $('#mange_update').submit();
            }else{
                toastr.error("! กรุณาใส่ข้อมูลให้ครบ")
            }
            return false;
        }
        
    }

    function req_detail(type, input){
        if (type=="vip") {
            window.location = `manage_cust_vip?cust_id=${input}`
        }
        
    }
  
</script>


<!-- ============================= ERROR Zone =============================-->
<!-- toastr.success('Lorem ipsum dolor sit amet, consetetur sadipscing elitr.')
toastr.info('Lorem ipsum dolor sit amet, consetetur sadipscing elitr.')
toastr.error('Lorem ipsum dolor sit amet, consetetur sadipscing elitr.')
toastr.warning('Lorem ipsum dolor sit amet, consetetur sadipscing elitr.') -->
<!-- ============================= ERROR Zone =============================-->