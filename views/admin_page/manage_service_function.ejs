<style>
    .container-fluid {
        padding: 12px;
    }

    .modal-body {
        padding-left: 30px;
        padding-right: 30px;
    }

    .modal-footer {
        padding-left: 30px;
        padding-right: 30px;
    }

    .form-control {
        background-color: rgba(175, 175, 175, 0.3);
    }
</style>

<div class="container-fluid">
    
    
    <div class="d-flex justify-content-center">
        <div class="">
            <div class="card card-body text-center" style="padding-left: 40px; padding-right: 40px;">
                <h3 >ระบบจัดการข้อมูลบริการ : <%= db_serv_group[0].name %> : <%= db_serv_type[0].name %> : <%= db_serv[0].name %></h3>
            </div>
        </div>
    </div>
  
    

    <div class="d-flex justify-content-start mb-2" style="gap: 5px">
        <a href="manage_service_group" class="btn btn-info">กลับไปที่จัดการกลุ่มบริการ</a>
        <a href="manage_service_type?group_id=<%=db_serv_group[0].id%>" class="btn btn-info">กลับไปที่จัดการประเภทบริการ</a>
        <a href="manage_service?group_id=<%=db_serv_group[0].id%>&type_id=<%=db_serv_type[0].id%>" class="btn btn-info">กลับไปที่จัดการบริการ</a>
        <button  type="button" class="btn btn-success" data-toggle="modal" data-target="#modal-add" onclick="">
            เพิ่มรูปแบบบริการ
        </button>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card card-body">
                
                <table id="service_function" class="table table-bordered table-hover " >
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>เวลา</th>
                            <th>ราคา</th>
                            <th>สินค้าที่ใช้</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <% for(let i of db_serv_func) {%>
                            <tr>
                                <td><%= i.id%></td>
                                <td><%= i.time%></td>
                                <td><%= i.price%></td>
                                <td>
                                    <div class="d-flex justify-content-start" style="gap: 6px">
                                    <% for(let j of i.list_prod) {%>
                                        <div class="d-flex justify-content-start p-1 rounded" style="background-color: rgba(128, 128, 128, 0.4);">
                                            <p class="text-center mb-0 p-1 px-3" style="background-color: transparent;">
                                                <%=j.prod_name%> : <%=j.qty%> 
                                            </p>
                                            <button  type="button" class="btn btn-warning p-1 py-0" data-toggle="modal" data-target="#modal-update-product"onclick="updateProd('<%=JSON.stringify(j)%>')">
                                                <i class="fas fa-pen fa-xs"></i>
                                            </button>
                                            <button  type="button" class="btn btn-danger p-1 " onclick="delProd('<%=j.id%>')" >
                                                <i class="fas fa-trash-alt fa-xs"></i>
                                            </button>
                                        </div>
                                    <% }%>
                                    <button  type="button" class="btn btn-secondary p-1 px-2" data-toggle="modal" data-target="#modal-add-product" onclick="addProd('<%=i.id%>')">เพิ่มสินค้า</button>

                                    </div>
                                </td>
                                <td>
                                    <div class="">
                                        <button  type="button" class="btn btn-warning p-1 px-1" data-toggle="modal" data-target="#modal-update"onclick="update('<%=JSON.stringify(i)%>') ">แก้
                                        </button>
                                        <button  type="button" class="btn btn-danger p-1 px-1" onclick="del('<%=i.id%>')" >ลบ</button>
                                    </div>
                                </td>
                                
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>


<form id="delete" action="manage_service_function/delete" method="post" class="d-inline">
    <input type="number" name="group_id" value="<%= db_serv_group[0].id %>" class="d-none">
    <input type="number" name="type_id" value="<%= db_serv_type[0].id %>" class="d-none">
    <input type="number" name="service_id" value="<%= db_serv[0].id %>" class="d-none">
    <input type="number" name="id_del" class="d-none" value="">
</form>

<form id="delete_product" action="manage_service_function/delete_product" method="post" class="d-inline">
    <input type="number" name="group_id" value="<%= db_serv_group[0].id %>" class="d-none">
    <input type="number" name="type_id" value="<%= db_serv_type[0].id %>" class="d-none">
    <input type="number" name="service_id" value="<%= db_serv[0].id %>" class="d-none">
    <input type="number" name="id_del_product" class="d-none" value="">
</form>

<!-- =================== Modal Insert===================-->
<div class="modal fade" id="modal-add">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-purple">
          <h4 class="modal-title ">เพิ่มรูปแบบบริการ</h4>
          <button type="button " class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true" class="text-light">&times;</span>
          </button>
        </div>
        <form id="mange_add" action="manage_service_function/add" method="post">
            <input type="number" class="form-control d-none" name="prod_type_id" value="" >
            <div class="modal-body">
            <!-- ============================== Form ==============================-->
                <div class="form-group">
                    <div class="form-group">
                        <label >เวลา</label>
                        <input type="text" class="form-control" name="time">
                    </div>
                    <div class="form-group">
                        <label >ราคา</label>
                        <input type="text" class="form-control" name="price">
                    </div>
                    <input type="number" name="group_id" value="<%= db_serv_group[0].id %>" class="d-none">
                    <input type="number" name="type_id" value="<%= db_serv_type[0].id %>" class="d-none">
                    <input type="number" name="service_id" value="<%= db_serv[0].id %>" class="d-none">
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-default" data-dismiss="modal">ยกเลิก</button>
                <button type="submit" class="btn btn-primary" onclick="return vali('add')">ยืนยัน</button>
            </div>

        </form>

      </div>
    </div>
</div>

<!-- =================== Modal Update ===================-->
<div class="modal fade" id="modal-update">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-purple">
          <h4 class="modal-title ">แก้ไขข้อมูลบริการ</h4>
          <button type="button " class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true" class="text-light">&times;</span>
          </button>
        </div>

        <form id="mange_update" action="manage_service_function/update" method="post">
            <div class="modal-body">
            <!-- ============================== Form ==============================-->
                <div class="form-group">
                    <label >เวลา</label>
                    <input type="text" class="form-control" name="Utime">
                </div>
                <div class="form-group">
                    <label >ราคา</label>
                    <input type="number" class="form-control" name="Uprice">
                </div>
                <input type="number" name="group_id" value="<%= db_serv_group[0].id %>" class="d-none">
                <input type="number" name="type_id" value="<%= db_serv_type[0].id %>" class="d-none">
                <input type="number" name="service_id" value="<%= db_serv[0].id %>" class="d-none">
                <input type="number" name="id_update" class="d-none" value="">
            </div>

            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-default" data-dismiss="modal">ยกเลิก</button>
                <button type="submit" class="btn btn-primary" onclick="return vali('update')">ยืนยัน</button>
            </div>

        </form>

      </div>
    </div>
</div>

<!-- =================== Modal Insert Product ===================-->
<div class="modal fade" id="modal-add-product">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-purple">
          <h4 class="modal-title ">เพิ่มสินค้าที่ใช้</h4>
          <button type="button " class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true" class="text-light">&times;</span>
          </button>
        </div>
        <form id="mange_add_product" action="manage_service_function/add_product" method="post">
            <div class="modal-body">
            <!-- ============================== Form ==============================-->
                <div class="form-group">
                    <label > เลือกสินค้า</label>
                    <select class="form-control" name="prod_id">
                        <% for(let i of db_product) {%>
                            <option value="<%= i.id%>"><%= i.id%> - <%= i.name%></option>
                        <%}%>
                    </select>
                </div>
                <div class="form-group">
                    <label >จำนวนที่ใช้</label>
                    <input type="number" class="form-control" name="qty">
                </div>
                <input type="number" name="sv_func_id" class="d-none" value="">
                <input type="number" name="group_id" value="<%= db_serv_group[0].id %>" class="d-none">
                <input type="number" name="type_id" value="<%= db_serv_type[0].id %>" class="d-none">
                <input type="number" name="service_id" value="<%= db_serv[0].id %>" class="d-none">
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-default" data-dismiss="modal">ยกเลิก</button>
                <button type="submit" class="btn btn-primary" onclick="return vali('add_product')">ยืนยัน</button>
            </div>

        </form>

      </div>
    </div>
</div>

<!-- =================== Modal Update Product ===================-->
<div class="modal fade" id="modal-update-product">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-purple">
          <h4 class="modal-title ">แก้ไขจำนวนสินค้าที่ใช้</h4>
          <button type="button " class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true" class="text-light">&times;</span>
          </button>
        </div>

        <form id="mange_update_product" action="manage_service_function/update_product" method="post">
            <div class="modal-body">
            <!-- ============================== Form ==============================-->
                <div class="form-group">
                    <label >ชื่อสินค้า</label>
                    <input class="form-control" name="Uprod_name" value="" readonly></input>
                </div>
                <div class="form-group">
                    <label >จำนวน</label>
                    <input type="number" class="form-control" name="Uqty">
                </div>
                <input type="number" name="id_update" class="d-none" value="">
                <input type="number" name="group_id" value="<%= db_serv_group[0].id %>" class="d-none">
                <input type="number" name="type_id" value="<%= db_serv_type[0].id %>" class="d-none">
                <input type="number" name="service_id" value="<%= db_serv[0].id %>" class="d-none">
            </div>

            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-default" data-dismiss="modal">ยกเลิก</button>
                <button type="submit" class="btn btn-primary" onclick="return vali('update_product')">ยืนยัน</button>
            </div>

        </form>

      </div>
    </div>
</div>

<script src="/axios/axios.min.js"></script>
<script>
    
    function axios_validation(url,params,form_id,error_text){
        axios({
            url:url,
            method:'get',
            params:params,
            timeout:3000
        }).then((result)=>{
            if( result.data.status == 1){
                $(form_id).submit();
            }else{
                toastr.error(error_text)
            }
        }).catch(()=>{
            toastr.error("404 Error Not Found")
        });
    }
</script>
<script>
    
    $(function () {
      $('#service_function').DataTable({
        "paging": true,
        "lengthMenu": [[5, 10, 20], [5, 10, 20]],
        "searching": true,
        "ordering": true,
        "info": true,
        "autoWidth": false,
        "responsive": true,
      }); 
    });

    function update(data){
        data = JSON.parse(data)
        $("input[name=Utime]").val(data.time);
        $("input[name=Uprice]").val(data.price);
        $("input[name=id_update]").val(data.id);
    }

    function del(id){
        $("input[name=id_del]").val(parseInt(id))
        if(confirm("ยืนการลบข้อมูล") == true){
            $("#delete").submit();
        }
    }

    function addProd(id){
        $("input[name=sv_func_id]").val(parseInt(id));
    }

    function updateProd(data){
        data = JSON.parse(data)
        $("input[name=Uprod_name]").val(data.prod_name);
        $("input[name=Uqty]").val(data.qty);
        $("input[name=id_update]").val(data.id);
    }

    function delProd(id){
        $("input[name=id_del_product]").val(parseInt(id))
        if(confirm("ยืนการลบข้อมูล") == true){
            $("#delete_product").submit();
        }
    }

    function vali(mode){
        /*
            Mode insert , update 
        */
        // (document.querySelector("input[name=Fname]").innerText).trim()
        if(mode === "add"){
            let time = ($("input[name=time]").val()).trim();
            let price = ($("input[name=price]").val()).trim();
            if( time !== "" && price !== ""){
                let params= {
                    time:time,
                    price:price,
                    serv_id:$("input[name=service_id]").val(),
                }
                axios_validation(
                    'manage_service_function/check_can_add',
                    params,
                    '#mange_add',
                    'มีรูปแบบบริการนี้อยู่เเล้ว'
                );
                
            }else{
                toastr.error("! กรุณาใส่ข้อมูลให้ครบ")
            }
            return false;
        }else if(mode === "update"){
            let time = ($("input[name=Utime]").val()).trim();
            let price = ($("input[name=Uprice]").val()).trim();
            if( time !== "" && price !== ""){
                let params= {
                    time:time,
                    price:price,
                    serv_id:$("input[name=service_id]").val(),
                    id:$("input[name=id_update]").val()
                }
                axios_validation(
                    'manage_service_function/check_can_update',
                    params,
                    '#mange_update',
                    'มีบริการนี้อยู่เเล้ว'
                );
            }else{
                toastr.error("! กรุณาใส่ข้อมูลให้ครบ")
            }
            return false;
        }else if(mode === "add_product"){
            let prod_id = ($("select[name=prod_id]").val()).trim();
            let qty = ($("input[name=qty]").val()).trim();
            if( prod_id !== "" && qty !== ""){
                let params= {
                    prod_id:prod_id,
                    qty:qty,
                    sv_func_id:$("input[name=sv_func_id]").val(),
                }
                axios_validation(
                    'manage_service_function/check_can_add_product',
                    params,
                    '#mange_add_product',
                    'มีสินค้านี้อยู่เเล้ว'
                );
                
            }else{
                toastr.error("! กรุณาใส่ข้อมูลให้ครบ")
            }
            return false;
        }else if(mode === "update_product"){
            let qty = ($("input[name=Uqty]").val()).trim();
            if( qty !== "" ){
                $("#mange_update_product").submit();
            }else{
                toastr.error("! กรุณาใส่ข้อมูลให้ครบ")
            }
            return false;
        }
        
    }
  
</script>

<!-- ============================= ERROR Zone =============================-->
<!-- toastr.success('Lorem ipsum dolor sit amet, consetetur sadipscing elitr.')
toastr.info('Lorem ipsum dolor sit amet, consetetur sadipscing elitr.')
toastr.error('Lorem ipsum dolor sit amet, consetetur sadipscing elitr.')
toastr.warning('Lorem ipsum dolor sit amet, consetetur sadipscing elitr.') -->
<!-- ============================= ERROR Zone =============================-->